<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>共振自動計算ツール</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* 簡易的なスタイル例 */
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1 {
      text-align: center;
    }
    .description {
      text-align: center;
      margin-bottom: 20px;
    }
    .input-section {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
    }
    .input-card {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      text-align: center;
      width: 100px;
    }
    .input-card img {
      width: 60px;
      height: 60px;
    }
    .input-card label {
      display: block;
      margin-top: 8px;
    }
    #calculate-btn {
      display: block;
      margin: 0 auto 20px;
      padding: 10px 20px;
      font-size: 16px;
    }
    #result-area {
      border-top: 1px solid #ddd;
      padding-top: 20px;
    }
    .pattern {
      border: 1px solid #888;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 10px;
    }
    .loading {
      text-align: center;
      font-style: italic;
      margin-bottom: 10px;
    }
    .error {
      color: red;
      text-align: center;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h1>共振自動計算ツール</h1>
  <div class="description">
    <p>
      「マイパーツ」にあるレジェンド以上のテックパーツと共振チップの所持数を入力し、<strong>Calculate</strong> ボタンを押すと、
      双生ドローン／サッカーの最適組合せを計算します。<br/>
    </p>
  </div>

  <div id="pyodide-loading" class="loading">Loading Pyodide…</div>
  <div id="error-message" class="error" style="display:none;"></div>

  <!-- パーツ入力セクション -->
  <div class="input-section">
    <!-- E -->
    <div class="input-card">
      <img src="images/E.png" alt="E" />
      <label for="count-E">E の枚数:</label>
      <input type="number" id="count-E" name="count-E" min="0" value="0" />
    </div>
    <!-- L0 -->
    <div class="input-card">
      <img src="images/L0.png" alt="L0" />
      <label for="count-L0">L0 の枚数:</label>
      <input type="number" id="count-L0" name="count-L0" min="0" value="0" />
    </div>
    <!-- L1 -->
    <div class="input-card">
      <img src="images/L1.png" alt="L1" />
      <label for="count-L1">L1 の枚数:</label>
      <input type="number" id="count-L1" name="count-L1" min="0" value="0" />
    </div>
    <!-- L2 -->
    <div class="input-card">
      <img src="images/L2.png" alt="L2" />
      <label for="count-L2">L2 の枚数:</label>
      <input type="number" id="count-L2" name="count-L2" min="0" value="0" />
    </div>
    <!-- L3 -->
    <div class="input-card">
      <img src="images/L3.png" alt="L3" />
      <label for="count-L3">L3 の枚数:</label>
      <input type="number" id="count-L3" name="count-L3" min="0" value="0" />
    </div>
    <!-- L4 -->
    <div class="input-card">
      <img src="images/L4.png" alt="L4" />
      <label for="count-L4">L4 の枚数:</label>
      <input type="number" id="count-L4" name="count-L4" min="0" value="0" />
    </div>
    <!-- Y（表示のみ：計算には直接使わない） -->
    <div class="input-card">
      <img src="images/Y.png" alt="Y" />
      <label>Y は定数（計算入力には使用しません）</label>
    </div>
    <!-- Chip -->
    <div class="input-card">
      <img src="images/chip_icon.png" alt="Chip" />
      <label for="count-chip">Chip 数 (0–330):</label>
      <!-- max を 330 に変更 -->
      <input type="number" id="count-chip" name="count-chip" min="0" max="330" value="0" />
    </div>
  </div>

  <!-- 計算ボタン -->
  <button id="calculate-btn">Calculate</button>

  <!-- 結果表示エリア -->
  <div id="result-area"></div>

  <!-- Pyodide 本体読み込み -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
  <script>
    let pyodideReady = false;
    let pyodide = null;

    // Pyodide 初期化と最新 Python コードの登録
    async function initPyodideAndPackages() {
      try {
        pyodide = await loadPyodide({
          indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/"
        });
        // Python 側で必要な標準ライブラリのみを使う
        await pyodide.runPythonAsync(`
import csv
from itertools import combinations_with_replacement

# ─────────────────────────────────────────────────────────
# 1) ルックアップテーブルを辞書化
lookup = {}
with open("Lookup_Table.csv", "r", encoding="utf-8") as f:
    reader = csv.DictReader(f)
    for row in reader:
        p_sorted = tuple(sorted([row["Const1"], row["Const2"], row["Const3"]]))
        c = int(row["Chip"])
        t = float(row["Total"])
        lookup[(p_sorted, c)] = t

available_chips = sorted({ c for (_, c) in lookup.keys() })

# 2) 3つパーツの組合せを入力枚数内で列挙
def generate_3parts_combinations(input_parts):
    # input_parts: {'E':nE, 'L0':nL0, ..., 'L4':nL4}
    results = set()
    unique_parts = list(input_parts.keys())
    for comb in combinations_with_replacement(unique_parts, 3):
        valid = True
        for p in set(comb):
            if comb.count(p) > input_parts.get(p, 0):
                valid = False
                break
        if valid:
            results.add(tuple(sorted(comb)))
    return list(results)

# 3) パレート最適解を返す
def pareto_optimal(pairs):
    final = []
    for a in pairs:
        td_a, ts_a = a
        dominated = False
        for b in pairs:
            td_b, ts_b = b
            if (td_b <= td_a and ts_b <= ts_a) and (td_b < td_a or ts_b < ts_a):
                dominated = True
                break
        if not dominated:
            final.append(a)
    return final

# 4) calculate 関数本体
def calculate(input_parts, chip_total):
    sum_parts = sum(input_parts.values())
    combos = generate_3parts_combinations(input_parts)

    # ＜6 の場合: chip_drone + chip_soccer <= chip_total を許容
    if sum_parts < 6:
        best = None
        best_diff = None
        for comb_drone in combos:
            for comb_soccer in combos:
                # チップ割り当てを「ルックアップキーとして存在する値」で探索
                for cd, ts_cd in [(k, None) for k in sorted({c for (_, c) in lookup.keys()})]:
                    # cd は LUT に存在するすべての chip キー
                    # cd が大きすぎるとルックアップ辞書参照で KeyError になるが、次の if で回避
                    for cs in sorted({c for (_, c) in lookup.keys()}):
                        if cd + cs > chip_total:
                            continue
                        if (comb_drone, cd) not in lookup or (comb_soccer, cs) not in lookup:
                            continue
                        td = lookup[(comb_drone, cd)]
                        ts = lookup[(comb_soccer, cs)]
                        if td < ts:
                            continue
                        diff = td - ts
                        # 差分が小さいものを優先。差分が同じなら td が小さいものを優先
                        if best is None or diff < best_diff or (diff == best_diff and td < best[0]):
                            best_diff = diff
                            best = (td, ts, comb_drone, comb_soccer, cd, cs)
        if best is None:
            return {"mode": "less6", "patterns": []}
        td, ts, comb_drone, comb_soccer, cd, cs = best
        rem = chip_total - (cd + cs)
        return {
            "mode": "less6",
            "patterns": [
                {
                    "drone_parts": list(comb_drone),
                    "chip_drone": cd,
                    "total_drone": td,
                    "soccer_parts": list(comb_soccer),
                    "chip_soccer": cs,
                    "total_soccer": ts,
                    "chip_remainder": rem
                }
            ]
        }

    # ≥6 の場合: chip_drone + chip_soccer <= chip_total を許容
    else:
        TARGETS = {900, 1200, 1650, 2100, 2550, 3000, 4500}
        candidates = []
        for comb_drone in combos:
            for comb_soccer in combos:
                for cd in sorted({c for (_, c) in lookup.keys()}):
                    for cs in sorted({c for (_, c) in lookup.keys()}):
                        if cd + cs > chip_total:
                            continue
                        if (comb_drone, cd) not in lookup or (comb_soccer, cs) not in lookup:
                            continue
                        td = lookup[(comb_drone, cd)]
                        ts = lookup[(comb_soccer, cs)]
                        if td < ts:
                            continue
                        # 両方とも TARGETS を満たすか?
                        if td in TARGETS and ts in TARGETS:
                            rem = chip_total - (cd + cs)
                            candidates.append((td, ts, comb_drone, comb_soccer, cd, cs, rem))
        if not candidates:
            return {"mode": "ge6", "patterns": []}
        # パレート最適解を抽出
        pareto_pairs = set(pareto_optimal([(c[0], c[1]) for c in candidates]))
        final = []
        for td, ts, comb_drone, comb_soccer, cd, cs, rem in candidates:
            if (td, ts) in pareto_pairs:
                final.append({
                    "drone_parts": list(comb_drone),
                    "chip_drone": cd,
                    "total_drone": td,
                    "soccer_parts": list(comb_soccer),
                    "chip_soccer": cs,
                    "total_soccer": ts,
                    "chip_remainder": rem
                })
        return {"mode": "ge6", "patterns": final}
`)
        pyodideReady = true;
        document.getElementById("pyodide-loading").style.display = "none";
      } catch (err) {
        document.getElementById("error-message").innerText = 
          "Pyodide の初期化中にエラーが発生しました: " + err;
        document.getElementById("error-message").style.display = "block";
      }
    }

    // 計算実行部分
    async function runCalculate() {
      if (!pyodideReady) {
        alert("Pyodide の初期化がまだ完了していません。少し待ってください。");
        return;
      }
      document.getElementById("result-area").innerHTML = "<div class='loading'>Calculating…</div>";

      // ユーザー入力を取得
      const inputParts = {
        "E": parseInt(document.getElementById("count-E").value) || 0,
        "L0": parseInt(document.getElementById("count-L0").value) || 0,
        "L1": parseInt(document.getElementById("count-L1").value) || 0,
        "L2": parseInt(document.getElementById("count-L2").value) || 0,
        "L3": parseInt(document.getElementById("count-L3").value) || 0,
        "L4": parseInt(document.getElementById("count-L4").value) || 0
      };
      const chipTotal = parseInt(document.getElementById("count-chip").value) || 0;

      // chipTotal 範囲チェック
      if (chipTotal < 0 || chipTotal > 330) {
        document.getElementById("result-area").innerHTML =
          "<div class='error'>Chip は 0～330 の範囲で入力してください。</div>";
        return;
      }

      // Python の calculate を呼び出す
      try {
        pyodide.globals.set("js_input_parts", inputParts);
        pyodide.globals.set("js_chip_total", chipTotal);
        const pyCode = `
result = calculate(js_input_parts, js_chip_total)
`;
        await pyodide.runPythonAsync(pyCode);
        const result = pyodide.globals.get("result").toJs();
        displayResult(result);
      } catch (err) {
        document.getElementById("result-area").innerHTML =
          "<div class='error'>計算中にエラーが発生しました: " + err + "</div>";
      }
    }

    // 結果を HTML に整形して表示
    function displayResult(res) {
      const container = document.getElementById("result-area");
      container.innerHTML = "";

      if (!res.patterns || res.patterns.length === 0) {
        container.innerHTML = "<div class='error'>条件を満たすパターンが見つかりませんでした。</div>";
        return;
      }

      const mode = res.mode === "less6" 
        ? "パーツ合計 < 6 のケース" 
        : "パーツ合計 ≧ 6 のケース（ターゲットあり）";
      const heading = document.createElement("h2");
      heading.innerText = mode;
      container.appendChild(heading);

      res.patterns.forEach((pat, idx) => {
        const div = document.createElement("div");
        div.classList.add("pattern");
        const html = `
          <p><strong>パターン ${idx+1}</strong></p>
          <p>
            <img src="images/drone_icon.png" alt="Drone" width="20" />
            <strong>Drone</strong><br/>
            ・Parts: ${pat.drone_parts.join(", ")}<br/>
            ・Chip: ${pat.chip_drone}<br/>
            ・Total: ${pat.total_drone}
          </p>
          <p>
            <img src="images/soccer_icon.png" alt="Soccer" width="20" />
            <strong>Soccer</strong><br/>
            ・Parts: ${pat.soccer_parts.join(", ")}<br/>
            ・Chip: ${pat.chip_soccer}<br/>
            ・Total: ${pat.total_soccer}
          </p>
          <p>チップ余り: ${pat.chip_remainder}</p>
        `;
        div.innerHTML = html;
        container.appendChild(div);
      });
    }

    // ページ読み込み時に Pyodide を初期化 & CSV をロード
    window.addEventListener("DOMContentLoaded", async () => {
      try {
        const response = await fetch("Lookup_Table.csv");
        if (!response.ok) {
          throw new Error("Lookup_Table.csv が見つかりません。GitHub Pages に正しくアップしたか確認してください。");
        }
        const csvText = await response.text();
        await initPyodideAndPackages();
        // CSV の内容を Pyodide の仮想ファイルシステムへ書き込む
        pyodide.FS.writeFile("Lookup_Table.csv", csvText);
      } catch (err) {
        document.getElementById("error-message").innerText = 
          "CSV 読み込み／Pyodide 初期化時にエラーが発生しました: " + err;
        document.getElementById("error-message").style.display = "block";
        document.getElementById("pyodide-loading").style.display = "none";
      }
    });

    // Calculate ボタンクリック時
    document.getElementById("calculate-btn").addEventListener("click", runCalculate);
  </script>
</body>
</html>
